{% extends "base.html" %}

{% block title %}Presets - Guitar-MIDI{% endblock %}

{% block content %}
<div class="presets-page">
    <!-- Preset Manager Header -->
    <section class="manager-header">
        <div class="instrument-card">
            <div class="instrument-header">
                <h2 class="instrument-title">Gesti√≥n de Presets</h2>
                <div class="manager-actions">
                    <button class="btn btn-primary" id="newPresetBtn">‚ûï Nuevo Preset</button>
                    <button class="btn btn-secondary" id="exportAllBtn">üì§ Exportar</button>
                    <button class="btn btn-secondary" id="importBtn">üì• Importar</button>
                </div>
            </div>
            <div class="current-preset-display">
                <div class="preset-info">
                    <span class="preset-label">Preset Actual:</span>
                    <span class="preset-name" id="currentPresetName">Default</span>
                    <span class="preset-status" id="currentPresetStatus">üü¢ Cargado</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions-section">
        <div class="section-header">
            <h2 class="section-title">Acciones R√°pidas</h2>
        </div>
        <div class="quick-actions-grid">
            <button class="quick-action-btn" id="saveCurrentStateBtn">
                <div class="action-icon">üíæ</div>
                <div class="action-text">Guardar Estado Actual</div>
            </button>
            <button class="quick-action-btn" id="loadLastSavedBtn">
                <div class="action-icon">üìÇ</div>
                <div class="action-text">Cargar √öltimo Guardado</div>
            </button>
            <button class="quick-action-btn" id="resetToDefaultBtn">
                <div class="action-icon">üîÑ</div>
                <div class="action-text">Reset a Default</div>
            </button>
            <button class="quick-action-btn" id="duplicateCurrentBtn">
                <div class="action-icon">üìã</div>
                <div class="action-text">Duplicar Actual</div>
            </button>
        </div>
    </section>

    <!-- Preset List -->
    <section class="preset-list-section">
        <div class="section-header">
            <h2 class="section-title">Presets Guardados</h2>
            <div class="list-controls">
                <input type="text" class="search-input" id="presetSearch" placeholder="üîç Buscar preset...">
                <select class="sort-select" id="sortSelect">
                    <option value="name">Ordenar por Nombre</option>
                    <option value="date">Ordenar por Fecha</option>
                </select>
            </div>
        </div>
        
        <div class="preset-list" id="presetList">
            <!-- Los presets se cargar√°n din√°micamente aqu√≠ -->
        </div>
    </section>

    <!-- Preset Details Modal -->
    <div class="modal" id="presetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detalles del Preset</h3>
                <button class="btn btn-secondary" id="closePresetModal">‚ùå</button>
            </div>
            <div class="modal-body">
                <div class="preset-form">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">üè∑Ô∏è</span>
                            <span class="label-text">Nombre del Preset</span>
                        </label>
                        <input type="text" class="form-input" id="presetNameInput" placeholder="Mi Preset Incre√≠ble">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">üìù</span>
                            <span class="label-text">Descripci√≥n</span>
                        </label>
                        <textarea class="form-input" id="presetDescription" rows="3" placeholder="Descripci√≥n del preset..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <span class="label-icon">üè∑Ô∏è</span>
                            <span class="label-text">Etiquetas</span>
                        </label>
                        <input type="text" class="form-input" id="presetTags" placeholder="rock, live, distorsi√≥n (separadas por comas)">
                    </div>
                </div>
                
                <div class="preset-preview">
                    <h4>Vista Previa de Configuraci√≥n</h4>
                    <div class="config-preview" id="configPreview">
                        <!-- La configuraci√≥n se mostrar√° aqu√≠ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelModalBtn">Cancelar</button>
                <button class="btn btn-primary" id="savePresetModalBtn">Guardar Preset</button>
            </div>
        </div>
    </div>

    <!-- File Input for Import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">
</div>
{% endblock %}

{% block styles %}
<style>
/* Estilos espec√≠ficos para la p√°gina de presets */
.presets-page {
    padding-bottom: 20px;
}

.current-preset-display {
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
}

.preset-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.preset-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.preset-name {
    font-weight: bold;
    color: var(--accent-color);
}

.preset-status {
    font-size: 0.875rem;
}

.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.quick-action-btn {
    background-color: var(--background-card);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
    text-align: center;
}

.quick-action-btn:hover {
    border-color: var(--accent-color);
    background-color: rgba(76, 175, 80, 0.1);
}

.quick-action-btn:active {
    transform: scale(0.95);
}

.action-icon {
    font-size: 2rem;
}

.action-text {
    font-size: 0.875rem;
    color: var(--text-primary);
    font-weight: 500;
}

.list-controls {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.search-input, .sort-select {
    padding: var(--spacing-sm);
    background-color: var(--secondary-color);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 0.875rem;
}

.search-input {
    flex: 1;
    min-width: 200px;
}

.preset-list {
    display: grid;
    gap: var(--spacing-md);
}

.preset-item {
    background-color: var(--background-card);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.preset-item:hover {
    border-color: var(--accent-color);
    background-color: rgba(76, 175, 80, 0.05);
}

.preset-item.active {
    border-color: var(--accent-color);
    background-color: rgba(76, 175, 80, 0.1);
}

.preset-item.active::before {
    content: '‚úì';
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    color: var(--accent-color);
    font-weight: bold;
    font-size: 1.25rem;
}

.preset-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-sm);
}

.preset-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.preset-actions {
    display: flex;
    gap: var(--spacing-xs);
    opacity: 0;
    transition: opacity 0.2s;
}

.preset-item:hover .preset-actions {
    opacity: 1;
}

.preset-btn {
    background-color: var(--secondary-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: var(--spacing-xs);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
}

.preset-btn:hover {
    color: var(--text-primary);
    border-color: var(--accent-color);
}

.preset-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: var(--spacing-sm);
    line-height: 1.4;
}

.preset-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.preset-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
}

.preset-tag {
    background-color: var(--secondary-color);
    color: var(--text-secondary);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.625rem;
}

.preset-date {
    white-space: nowrap;
}

.config-preview {
    background-color: var(--secondary-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    margin-top: var(--spacing-sm);
}

.config-item {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-xs) 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.875rem;
}

.config-item:last-child {
    border-bottom: none;
}

.config-key {
    color: var(--text-secondary);
}

.config-value {
    color: var(--text-primary);
    font-weight: 500;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
}

@media (max-width: 480px) {
    .list-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-input {
        min-width: unset;
    }
    
    .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .preset-header {
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    .preset-actions {
        opacity: 1;
    }
    
    .preset-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }
}

@media (max-width: 360px) {
    .quick-actions-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Estado del gestor de presets
let currentPresets = {};
let currentPresetName = 'default';
let isEditMode = false;
let editingPresetName = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPresets();
    initializePresetManager();
});

function loadPresets() {
    fetch('/api/presets')
        .then(response => response.json())
        .then(presets => {
            currentPresets = presets;
            renderPresetList();
        })
        .catch(error => {
            console.error('Error loading presets:', error);
            showToast('Error al cargar presets', 'error');
        });
}

function initializePresetManager() {
    // Quick actions
    document.getElementById('newPresetBtn').addEventListener('click', createNewPreset);
    document.getElementById('saveCurrentStateBtn').addEventListener('click', saveCurrentState);
    document.getElementById('loadLastSavedBtn').addEventListener('click', loadLastSaved);
    document.getElementById('resetToDefaultBtn').addEventListener('click', resetToDefault);
    document.getElementById('duplicateCurrentBtn').addEventListener('click', duplicateCurrent);
    document.getElementById('exportAllBtn').addEventListener('click', exportAllPresets);
    document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
    
    // Search and sort
    document.getElementById('presetSearch').addEventListener('input', filterPresets);
    document.getElementById('sortSelect').addEventListener('change', sortPresets);
    
    // Modal
    document.getElementById('closePresetModal').addEventListener('click', closePresetModal);
    document.getElementById('cancelModalBtn').addEventListener('click', closePresetModal);
    document.getElementById('savePresetModalBtn').addEventListener('click', savePresetFromModal);
    
    // File import
    document.getElementById('importFileInput').addEventListener('change', importPresets);
    
    // Close modal on outside click
    document.getElementById('presetModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePresetModal();
        }
    });
}

function renderPresetList() {
    const container = document.getElementById('presetList');
    container.innerHTML = '';
    
    if (Object.keys(currentPresets).length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìÅ</div>
                <div class="empty-text">No hay presets guardados</div>
                <div class="empty-subtext">Crea tu primer preset usando las acciones r√°pidas</div>
            </div>
        `;
        return;
    }
    
    Object.entries(currentPresets).forEach(([name, preset]) => {
        const presetElement = createPresetElement(name, preset);
        container.appendChild(presetElement);
    });
}

function createPresetElement(name, preset) {
    const div = document.createElement('div');
    div.className = `preset-item ${name === currentPresetName ? 'active' : ''}`;
    div.dataset.presetName = name;
    
    const tags = preset.tags || [];
    const tagsHtml = tags.map(tag => `<span class="preset-tag">${tag}</span>`).join('');
    
    div.innerHTML = `
        <div class="preset-header">
            <h3 class="preset-title">${name}</h3>
            <div class="preset-actions">
                <button class="preset-btn load-btn" title="Cargar">üìÇ</button>
                <button class="preset-btn edit-btn" title="Editar">‚úèÔ∏è</button>
                <button class="preset-btn duplicate-btn" title="Duplicar">üìã</button>
                <button class="preset-btn delete-btn" title="Eliminar">üóëÔ∏è</button>
            </div>
        </div>
        <div class="preset-description">${preset.description || 'Sin descripci√≥n'}</div>
        <div class="preset-meta">
            <div class="preset-tags">${tagsHtml}</div>
            <div class="preset-date">${formatDate(preset.created_at || new Date())}</div>
        </div>
    `;
    
    // Event listeners
    div.querySelector('.load-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        loadPreset(name);
    });
    
    div.querySelector('.edit-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        editPreset(name);
    });
    
    div.querySelector('.duplicate-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        duplicatePreset(name);
    });
    
    div.querySelector('.delete-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        deletePreset(name);
    });
    
    div.addEventListener('click', () => loadPreset(name));
    
    return div;
}

function createNewPreset() {
    isEditMode = false;
    editingPresetName = null;
    document.getElementById('modalTitle').textContent = 'Crear Nuevo Preset';
    document.getElementById('presetNameInput').value = '';
    document.getElementById('presetDescription').value = '';
    document.getElementById('presetTags').value = '';
    updateConfigPreview();
    openPresetModal();
}

function editPreset(name) {
    isEditMode = true;
    editingPresetName = name;
    const preset = currentPresets[name];
    
    document.getElementById('modalTitle').textContent = 'Editar Preset';
    document.getElementById('presetNameInput').value = name;
    document.getElementById('presetDescription').value = preset.description || '';
    document.getElementById('presetTags').value = (preset.tags || []).join(', ');
    updateConfigPreview();
    openPresetModal();
}

function duplicatePreset(name) {
    const originalPreset = currentPresets[name];
    const newName = `${name} (copia)`;
    
    isEditMode = false;
    editingPresetName = null;
    document.getElementById('modalTitle').textContent = 'Duplicar Preset';
    document.getElementById('presetNameInput').value = newName;
    document.getElementById('presetDescription').value = originalPreset.description || '';
    document.getElementById('presetTags').value = (originalPreset.tags || []).join(', ');
    updateConfigPreview();
    openPresetModal();
}

function deletePreset(name) {
    if (!confirm(`¬øEliminar el preset "${name}"?`)) {
        return;
    }
    
    fetch(`/api/presets/${name}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            delete currentPresets[name];
            renderPresetList();
            showToast(`Preset "${name}" eliminado`, 'success');
            
            if (name === currentPresetName) {
                currentPresetName = 'default';
                updateCurrentPresetDisplay();
            }
        } else {
            showToast('Error al eliminar preset', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting preset:', error);
        showToast('Error de conexi√≥n', 'error');
    });
}

function loadPreset(name) {
    showLoading(true);
    
    fetch(`/api/presets/${name}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        showLoading(false);
        
        if (result.success) {
            currentPresetName = name;
            updateCurrentPresetDisplay();
            renderPresetList();
            showToast(`Preset "${name}" cargado`, 'success');
        } else {
            showToast('Error al cargar preset', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error loading preset:', error);
        showToast('Error de conexi√≥n', 'error');
    });
}

function saveCurrentState() {
    const name = prompt('Nombre para el estado actual:', `Estado ${new Date().toLocaleString()}`);
    if (!name) return;
    
    getCurrentSystemState()
        .then(state => savePreset(name, state, 'Estado actual del sistema'))
        .catch(error => {
            console.error('Error getting current state:', error);
            showToast('Error al obtener estado actual', 'error');
        });
}

function savePreset(name, state, description = '', tags = []) {
    const presetData = {
        ...state,
        description: description,
        tags: tags,
        created_at: new Date().toISOString()
    };
    
    showLoading(true);
    
    fetch(`/api/presets/${name}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(presetData)
    })
    .then(response => response.json())
    .then(result => {
        showLoading(false);
        
        if (result.success) {
            currentPresets[name] = presetData;
            renderPresetList();
            showToast(`Preset "${name}" guardado`, 'success');
        } else {
            showToast('Error al guardar preset', 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error saving preset:', error);
        showToast('Error de conexi√≥n', 'error');
    });
}

function getCurrentSystemState() {
    return fetch('/api/system/state')
        .then(response => response.json())
        .then(data => data.state || {})
        .catch(() => window.appState || {});
}

function updateCurrentPresetDisplay() {
    document.getElementById('currentPresetName').textContent = currentPresetName;
    document.getElementById('currentPresetStatus').textContent = 'üü¢ Cargado';
}

function updateConfigPreview() {
    const preview = document.getElementById('configPreview');
    
    getCurrentSystemState()
        .then(state => {
            preview.innerHTML = '';
            
            if (state.instruments) {
                const instrumentCount = Object.keys(state.instruments).length;
                preview.innerHTML += `<div class="config-item"><span class="config-key">Instrumentos configurados:</span><span class="config-value">${instrumentCount}</span></div>`;
            }
            
            if (state.effects) {
                Object.entries(state.effects).forEach(([key, value]) => {
                    preview.innerHTML += `<div class="config-item"><span class="config-key">${key}:</span><span class="config-value">${value}%</span></div>`;
                });
            }
            
            if (preview.innerHTML === '') {
                preview.innerHTML = '<div class="config-item"><span class="config-key">Estado:</span><span class="config-value">Configuraci√≥n vac√≠a</span></div>';
            }
        });
}

function openPresetModal() {
    document.getElementById('presetModal').classList.add('show');
}

function closePresetModal() {
    document.getElementById('presetModal').classList.remove('show');
}

function savePresetFromModal() {
    const name = document.getElementById('presetNameInput').value.trim();
    const description = document.getElementById('presetDescription').value.trim();
    const tagsInput = document.getElementById('presetTags').value.trim();
    const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
    
    if (!name) {
        showToast('El nombre del preset es requerido', 'warning');
        return;
    }
    
    if (!isEditMode && currentPresets[name]) {
        if (!confirm(`Ya existe un preset con el nombre "${name}". ¬øSobreescribir?`)) {
            return;
        }
    }
    
    getCurrentSystemState()
        .then(state => {
            savePreset(name, state, description, tags);
            closePresetModal();
            
            if (isEditMode && editingPresetName !== name) {
                // Si se cambi√≥ el nombre, eliminar el preset anterior
                delete currentPresets[editingPresetName];
            }
        })
        .catch(error => {
            console.error('Error getting current state:', error);
            showToast('Error al obtener estado actual', 'error');
        });
}

// Otras funciones auxiliares
function loadLastSaved() {
    const presetNames = Object.keys(currentPresets);
    if (presetNames.length === 0) {
        showToast('No hay presets guardados', 'warning');
        return;
    }
    
    // Encontrar el preset m√°s reciente
    const lastSaved = presetNames.reduce((latest, name) => {
        const current = currentPresets[name];
        const latestPreset = currentPresets[latest];
        return new Date(current.created_at || 0) > new Date(latestPreset.created_at || 0) ? name : latest;
    });
    
    loadPreset(lastSaved);
}

function resetToDefault() {
    if (!confirm('¬øResetear a configuraci√≥n por defecto?')) {
        return;
    }
    
    fetch('/api/system/reset', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            currentPresetName = 'default';
            updateCurrentPresetDisplay();
            renderPresetList();
            showToast('Sistema reseteado a valores por defecto', 'success');
        } else {
            showToast('Error al resetear sistema', 'error');
        }
    })
    .catch(error => {
        console.error('Error resetting system:', error);
        showToast('Error de conexi√≥n', 'error');
    });
}

function duplicateCurrent() {
    getCurrentSystemState()
        .then(state => {
            const name = prompt('Nombre para el preset duplicado:', `${currentPresetName} (copia)`);
            if (name) {
                savePreset(name, state, `Copia de ${currentPresetName}`);
            }
        });
}

function exportAllPresets() {
    const dataStr = JSON.stringify(currentPresets, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `guitar-midi-presets-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showToast('Presets exportados', 'success');
}

function importPresets(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedPresets = JSON.parse(e.target.result);
            
            if (typeof importedPresets !== 'object') {
                throw new Error('Formato de archivo inv√°lido');
            }
            
            // Merge presets
            const conflicts = [];
            Object.keys(importedPresets).forEach(name => {
                if (currentPresets[name]) {
                    conflicts.push(name);
                }
            });
            
            if (conflicts.length > 0) {
                const overwrite = confirm(`Se encontraron ${conflicts.length} presets con nombres duplicados. ¬øSobreescribir?`);
                if (!overwrite) return;
            }
            
            Object.assign(currentPresets, importedPresets);
            renderPresetList();
            showToast(`${Object.keys(importedPresets).length} presets importados`, 'success');
            
        } catch (error) {
            console.error('Error importing presets:', error);
            showToast('Error al importar presets', 'error');
        }
    };
    
    reader.readAsText(file);
    event.target.value = ''; // Reset input
}

function filterPresets() {
    const searchTerm = document.getElementById('presetSearch').value.toLowerCase();
    const presetItems = document.querySelectorAll('.preset-item');
    
    presetItems.forEach(item => {
        const name = item.dataset.presetName.toLowerCase();
        const description = item.querySelector('.preset-description').textContent.toLowerCase();
        const tags = Array.from(item.querySelectorAll('.preset-tag')).map(tag => tag.textContent.toLowerCase()).join(' ');
        
        const matches = name.includes(searchTerm) || description.includes(searchTerm) || tags.includes(searchTerm);
        item.style.display = matches ? 'block' : 'none';
    });
}

function sortPresets() {
    const sortBy = document.getElementById('sortSelect').value;
    const container = document.getElementById('presetList');
    const items = Array.from(container.children);
    
    items.sort((a, b) => {
        const nameA = a.dataset.presetName;
        const nameB = b.dataset.presetName;
        
        if (sortBy === 'name') {
            return nameA.localeCompare(nameB);
        } else if (sortBy === 'date') {
            const dateA = new Date(currentPresets[nameA].created_at || 0);
            const dateB = new Date(currentPresets[nameB].created_at || 0);
            return dateB - dateA;
        }
        
        return 0;
    });
    
    items.forEach(item => container.appendChild(item));
}

function formatDate(date) {
    return new Date(date).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>
{% endblock %}